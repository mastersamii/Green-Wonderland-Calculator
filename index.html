<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Green Wonderland Order Calculator</title>
<style>
  :root{
    --leaf:#2e7d32; 
    --mint:#86d387; 
    --ink:#1f2430; 
    --muted:#5c6a60;

    --bg:#eef4ef;
    --panel:#f7fbf8;
    --card:#ffffff;
    --chip:#edf5ee;
    --border:#a8b9ad;
    --border-strong:#8ba093;
    --radius:16px; 
    --shadow:0 10px 24px rgba(0,0,0,.08);
    --accent:var(--leaf);

    /* GREEN DARK THEME */
    --bg-dark:#0e1410; 
    --panel-dark:#151c16; 
    --card-dark:#192219; 
    --chip-dark:#1f2a20; 
    --text-dark:#e8f3ea; 
    --border-dark:#2a3b2d;
    --border-strong-dark:#384a3e;
  }

  [data-theme="dark"]{ 
    --bg:var(--bg-dark); 
    --panel:var(--panel-dark); 
    --card:var(--card-dark); 
    --chip:var(--chip-dark); 
    --border:var(--border-dark); 
    --ink:var(--text-dark); 
    --muted:#a6b3a8; 
    --border-strong:var(--border-strong-dark);
  }
[data-theme="dark"] select,
[data-theme="dark"] option {
  background: var(--card-dark) !important;
  color: var(--text-dark) !important;
  border: 1px solid var(--border-dark) !important;
}

[data-theme="dark"] option:hover,
[data-theme="dark"] option:focus {
  background: var(--leaf) !important;
  color: #fff !important;
}

  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:
      radial-gradient(1200px 600px at 50% -200px, rgba(46,125,50,.06), transparent 60%),
      var(--bg);
    color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Arial
  }
  h1,h2,h3{font-family:Georgia,"Times New Roman",serif;letter-spacing:.2px}
  .container{max-width:1200px;margin:28px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}

  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:48px;height:48px;border-radius:12px;
    box-shadow:var(--shadow);
    background:conic-gradient(from 0deg,#fff 0 30%,#86d387 0 55%,#2e7d32 0 100%);
    display:grid;place-items:center
  }
  .logo span{font-size:22px}

  .toolrow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  .btn{
    display:inline-flex;align-items:center;justify-content:center;
    padding:10px 14px;border-radius:12px;border:1px solid var(--border);
    background:var(--chip);color:inherit;font-weight:600;cursor:pointer;text-decoration:none;
    box-shadow:0 1px 0 rgba(0,0,0,.02);
  }
  .btn:hover{filter:brightness(0.98)}
  .btn:focus-visible{outline:2px solid var(--mint);outline-offset:2px}
  .btn.primary{background:linear-gradient(135deg,var(--leaf),#44a049);color:#fff;border:none}
  .btn.ghost{background:transparent}
  .chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-weight:700;color:var(--muted);font-size:.85rem}

  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}

  .panel{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    position:relative;
  }
  .panel::after{
    content:"";position:absolute;inset:0;border-radius:calc(var(--radius) - 1px);
    box-shadow:inset 0 0 0 1px var(--border-strong);
    pointer-events:none;
  }
  .panel h2{margin:0;padding:14px 16px;font-size:1rem;border-bottom:1px solid var(--border);background:rgba(255,255,255,.04)}
  .panel .content{padding:14px}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;
    box-shadow:0 1px 0 rgba(0,0,0,.03);
    position:relative;
  }
  .card::after{content:"";position:absolute;inset:0;border-radius:13px;pointer-events:none;box-shadow:inset 0 0 0 1px var(--border-strong)}
  .price{color:var(--accent);font-weight:800}

  .qty{display:grid;grid-template-columns:32px 1fr 32px;align-items:center;gap:8px}
  .qty button{height:36px;border-radius:10px;border:1px solid var(--border);background:var(--chip);font-size:18px;cursor:pointer}
  .qty button:hover{filter:brightness(0.98)}
  .qty output{text-align:center}
  .muted{color:var(--muted);font-size:.9rem}

  .order-card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;padding:6px;
    box-shadow:0 1px 0 rgba(0,0,0,.03);
    position:relative;
  }
  .order-card::after{content:"";position:absolute;inset:0;border-radius:13px;pointer-events:none;box-shadow:inset 0 0 0 1px var(--border-strong)}
  .cart-item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:8px;border-bottom:1px dashed var(--border)}
  .cart-item:last-child{border-bottom:none}

  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tabs .btn[aria-selected="true"]{outline:2px solid var(--accent)}

  .summary{display:flex;flex-direction:column;gap:12px}
  .summary .row{display:flex;justify-content:space-between;align-items:center}
  .summary .row.total{font-size:1.2rem;font-weight:900}
  .divider{height:1px;background:var(--border);margin:10px 0}

  .discount{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .kbd{font:700 .9rem ui-monospace,Menlo,Consolas;background:transparent;border:2px solid #3e8e41;color:#3e8e41;border-radius:8px;padding:4px 8px}

  dialog{
    width:min(780px,92vw);background:var(--panel);color:inherit;border:1px solid var(--border);
    border-radius:18px;padding:0;box-shadow:0 30px 50px rgba(0,0,0,.35)
  }
  dialog::backdrop{background:rgba(0,0,0,.55)}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
  .modal-body{padding:14px;display:grid;gap:14px}

  .selector-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
  .select-card{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:10px;display:flex;flex-direction:column;gap:8px;position:relative}
  .select-card::after{content:"";position:absolute;inset:0;border-radius:11px;pointer-events:none;box-shadow:inset 0 0 0 1px var(--border-strong)}
  .select-title{font-weight:800}
  .select-qty{display:grid;grid-template-columns:32px 1fr 32px;gap:8px;align-items:center}
  .select-qty button{height:32px;border-radius:8px;border:1px solid var(--border);background:var(--chip);cursor:pointer}
  .select-qty button:hover{filter:brightness(0.98)}

  select, input[type="radio"]{accent-color:var(--accent)}
  select{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:6px 8px;box-shadow:inset 0 0 0 1px var(--border-strong)}
  .option-list{display:grid;gap:8px}
  .option-row{display:flex;align-items:center;gap:10px;justify-content:space-between;border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--card)}
  .option-row label{display:flex;align-items:center;gap:8px}

  /*  rows: each row has exactly two cards (Joint, Quarter) */
  .-rows{display:grid;gap:12px}
  .cards-2{display:grid;grid-template-columns:repeat(2,minmax(230px,1fr));gap:12px}
  @media (max-width:980px){
    .cards-2{grid-template-columns:1fr}
  }
  .-row h4{margin:0 0 6px;font-size:1rem}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo"><span>🌿</span></div>
      <div>
        <h1 style="margin:0">Green Wonderland Order Calculator</h1>
        <div class="muted">Build carts, pick bundles, apply discounts, and see exact totals + ingredients.</div>
      </div>
    </div>
    <div class="toolrow">
      <span class="chip">Autosaves</span>
      <button class="btn ghost" id="themeBtn" aria-pressed="false">🌙 Dark</button>
      <button class="btn ghost" id="resetBtn">Clear All</button>
      <button class="btn primary" id="checkoutBtn">Checkout</button>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <section class="panel">
      <h2>Menu</h2>
      <div class="content">
        <h3 style="margin:0 0 6px">Geek Bars & Vapes</h3>
        <div class="cards" id="vapes"></div>

        <div class="divider"></div>

        <h3 style="margin:0 0 6px">Refills</h3>
        <div class="cards" id="refills"></div>

        <div class="divider"></div>

        <h3 style="margin:0 0 6px">Flower</h3>
        <!-- Three horizontal rows: Basic, Premium, Exotic -->
        <div class="flower-rows">
          <div class="flower-row">
            <h4>Basic</h4>
            <div class="cards-2" id="flower-basic"></div>
          </div>
          <div class="flower-row">
            <h4>Premium</h4>
            <div class="cards-2" id="flower-premium"></div>
          </div>
          <div class="flower-row">
            <h4>Exotic</h4>
            <div class="cards-2" id="flower-exotic"></div>
          </div>
        </div>

        <div class="divider"></div>

        <h3 style="margin:0 0 6px">Edibles</h3>
        <div class="cards" id="edibles"></div>

        <div class="divider"></div>

        <h3 style="margin:0 0 6px">Bundles</h3>
        <div class="cards" id="bundles"></div>

        <div class="divider"></div>

        <h3 style="margin:0 0 6px">Accessories & Snacks</h3>
        <div class="cards" id="extras"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="panel">
      <h2>Orders</h2>
      <div class="content">
        <div class="tabs" role="tablist">
          <button class="btn" data-tab="summary" aria-selected="true">🧾 Summary</button>
          <button class="btn" data-tab="ingredients" aria-selected="false">🧺 Ingredients</button>
          <button class="btn" data-tab="history" aria-selected="false">📜 History</button>
        </div>

        <div id="tab-summary" role="tabpanel">
          <div class="option" style="display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:12px;background:var(--card);padding:10px 12px;margin-bottom:10px;box-shadow:inset 0 0 0 1px var(--border-strong)">
            <div>
              <div><strong>Fulfillment</strong></div>
              <div class="muted">City $50 · Sandy $100 · Paleto $150</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <label><input type="radio" name="fulfill" value="pickup"> Pickup</label>
              <label><input type="radio" name="fulfill" value="delivery"> Delivery</label>
              <select id="zoneSelect" style="margin-left:6px">
                <option value="city">City</option>
                <option value="sandy">Sandy</option>
                <option value="paleto">Paleto</option>
              </select>
            </div>
          </div>

          <div id="cart" class="order-card">
            <div class="cart-item muted">Your order is empty. Add an item to get started.</div>
          </div>

          <div class="divider"></div>

          <div class="discount">
            <label for="discountRange">Discount</label>
            <div><span id="discountLabel" class="kbd">0%</span></div>
            <input id="discountRange" type="range" min="0" max="100" step="5" value="0"/>
          </div>

          <div class="summary" style="margin-top:10px">
            <div class="row"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
            <div class="row" id="deliveryRow" style="display:none"><span>Delivery Fee</span><strong id="deliveryFee">$0.00</strong></div>
            <div class="row"><span>Discount</span><strong id="discount">-$0.00</strong></div>
            <div class="row"><span>Promotions</span><strong id="promotions">-$0.00</strong></div>
            <div class="row total"><span>Total</span><strong id="total">$0.00</strong></div>
            <div class="muted" id="promoNotes"></div>
          </div>

          <div style="margin-top:10px" class="toolrow">
            <button class="btn primary" id="checkoutBtn2">Checkout</button>
            <button class="btn ghost" id="resetBtn2">Clear All</button>
          </div>
        </div>

        <div id="tab-ingredients" role="tabpanel" hidden>
          <div class="muted" style="margin-bottom:6px">Auto-aggregated from your cart.</div>
          <div id="ingredientList" class="order-card" style="padding:12px">
            <div class="muted">No ingredients yet. Add items to the cart.</div>
          </div>
          <div class="toolrow" style="justify-content:flex-end;margin-top:10px">
            <button class="btn" id="copyIngBtn">Copy List</button>
            <button class="btn" id="exportIngBtn">Export CSV</button>
          </div>
        </div>

        <div id="tab-history" role="tabpanel" hidden>
          <div id="historyList" class="summary" style="gap:12px"></div>
          <div class="toolrow" style="justify-content:flex-end;margin-top:10px">
            <button class="btn ghost" id="clearHistoryBtn">Clear History</button>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Selector Modal (bundles & flavors & strains) -->
<dialog id="comboModal">
  <div class="modal-header">
    <strong id="comboTitle">Choose Items</strong>
    <button class="btn" id="closeCombo">✕</button>
  </div>
  <div class="modal-body">
    <div id="comboSteps" class="muted"></div>
    <div id="comboContent"></div>
    <div class="toolrow" style="justify-content:flex-end;margin-top:6px">
      <button class="btn" id="comboPrev" style="display:none">Back</button>
      <button class="btn primary" id="comboNext">Next</button>
    </div>
  </div>
</dialog>

<script>
/* =========================
   CONFIG / DATA
========================= */
const MENU = {
  vapes: [
    { id:'geek-plain',  name:'Geek Bar (Plain)',    price:800,  type:'vape' },
    { id:'geek-flavor', name:'Geek Bar (Flavored)', price:1000, type:'vape', needsFlavor: true },
    { id:'geek-thc',    name:'Geek Bar (THC)',      price:1100, type:'vape' },

    { id:'penjamin', name:'Penjamin', price:500, type:'vape' },
    { id:'bong',     name:'Bong',     price:700, type:'accessory' }
  ],

  refills: [
    { id:'refill-plain',  name:'Refill: Geek Bar (Plain)',    price:400, type:'service' },
    { id:'refill-flavor', name:'Refill: Geek Bar (Flavored)', price:400, type:'service', needsFlavor: true },
    { id:'refill-thc',    name:'Refill: Geek Bar (THC)',      price:500, type:'service' }
  ],

  /* Flower entry points: Joint/Quarter per tier; strain chosen inside modal */
  flowerEntry: [
    { id:'basic-joint',   name:'Basic Joint',   price:150, type:'flower', tier:'Basic',   pickStrain:true },
    { id:'basic-quarter', name:'Basic Quarter', price:150, type:'flower', tier:'Basic',   pickStrain:true },
    { id:'premium-joint',   name:'Premium Joint',   price:250, type:'flower', tier:'Premium', pickStrain:true },
    { id:'premium-quarter', name:'Premium Quarter', price:250, type:'flower', tier:'Premium', pickStrain:true },
    { id:'exotic-joint',   name:'Exotic Joint',   price:350, type:'flower', tier:'Exotic',  pickStrain:true },
    { id:'exotic-quarter', name:'Exotic Quarter', price:350, type:'flower', tier:'Exotic',  pickStrain:true }
  ],

  edibles: [
    { id:'brownie-6', name:'Brownie 6 pack', price:250, type:'edible' },
    { id:'gummy-3',   name:'Gummy 3 pack',  price:250, type:'edible' },
  ],

  /* Bundles */
  bundles: [
    
    { id:'bd-starter', name:'Starter Pack (Plain)', price:1100, type:'bundle',
      components:[{id:'geek-plain',qty:1},{id:'refill-plain',qty:1}],
      snackChoice:true,
      description:'Geek Bar (Plain) + Refill (Plain) + snack of your choice.' },

    { id:'bd-flavor-fan', name:'Flavor Fan', price:1250, type:'bundle',
      components:[{id:'geek-flavor',qty:1,needsFlavor:true},{id:'refill-flavor',qty:1,needsFlavor:true}],
      snackChoice:true,
      description:'Flavored Geek Bar + Refill (Flavored) + snack of your choice.' },

    { id:'bd-thc-chill', name:'THC Chill', price:1450, type:'bundle',
      components:[{id:'geek-thc',qty:1},{id:'refill-thc',qty:1}],
      snackChoice:true,
      description:'Geek Bar (THC) + Refill (THC) + snack of your choice.' },

    /* Vape mix bundles (percentage discount) */
    { id:'bd-vape-duo',  name:'Vape Duo (any 2)',  type:'bundle',
      dynamic:{ from:'vapes', count:2, discountPct:10 }, description:'Pick any 2 vapes and get 10% off.' },

    { id:'bd-vape-trio', name:'Vape Trio (any 3)', type:'bundle',
      dynamic:{ from:'vapes', count:3, discountPct:15 }, description:'Pick any 3 vapes and get 15% off.' },

    /* Refill packs (with snack choice, discount on refills; snack is free) */
    { id:'bd-refill-2', name:'Refill 2-Pack + Snack', type:'bundle',
      dynamic:{ from:'refills', count:2, discountPct:10, snackFree:true }, snackChoice:true,
      description:'Pick any 2 refills (10% off) and a free snack.' },

    { id:'bd-refill-3', name:'Refill 3-Pack + Snack', type:'bundle',
      dynamic:{ from:'refills', count:3, discountPct:15, snackFree:true }, snackChoice:true,
      description:'Pick any 3 refills (15% off) and a free snack.' },

    /* Existing edible duo stays */
    { id:'bd-edibles', name:'Edible Duo (pick 2)', price:450, type:'bundle', ediblesIncluded:2,
      description:'Choose any 2 edible packs.' }
  ],

  extras: [
    { id:'lighter',   name:'Lighter',        price:13,   type:'extra' },
    { id:'wallet',    name:'Wallet',         price:650,  type:'extra' },
    { id:'lunch-box', name:'Lunch Box',      price:715,  type:'extra' },
    { id:'green-rolls', name:'Green Rolls',  price:300,  type:'extra' },
    { id:'almond-joy', name:'Almond Joy',    price:25,   type:'extra' },
    { id:'rice-kris',  name:'Rice Krispies', price:30,   type:'extra' },
    { id:'cocoa',      name:'Cocoa Powder',  price:25,   type:'extra' },
    { id:'jolly',      name:'Jolly Ranchers',price:25,   type:'extra' }
  ]
};

/* Flower strains */
const STRAIN_GROUPS = [
  { tier:'Basic', price:150, items:['AK-47','Sour Diesel','Blue Dream'] },
  { tier:'Premium', price:250, items:['Bubble Berry','Trainwreck','OG Kush','Gorilla Glue'] },
  { tier:'Exotic', price:350, items:['Northern Lights'] }
];

/* Flavors for flavored Geek Bar / Refill */
const VAPE_FLAVORS = ['Strawberry','Mango','Apple','Menthol','Blueberry'];

/* Snack choices (no lighter) */
const SNACK_IDS = ['almond-joy','rice-kris','jolly'];

/* RECIPE MAP for edibles (for ingredients tab) */
const RECIPE_MAP = {
  'brownie-6': { 'Packaged Weed':1, 'Cocoa Powder':2 },
  'gummy-3'  : { 'Packaged Weed':1, 'Jolly Ranchers':2 }
};

const currency = n => '$'+Number(n).toFixed(2);

/* =========================
   STATE / PERSIST
========================= */
const STATE_KEY='gw_state_v1', HIST_KEY='gw_hist_v1';
const state = { cart:[], discountPct:0, history:[], fulfillment:'pickup', deliveryZone:'city' };

try{
  const saved = JSON.parse(localStorage.getItem(STATE_KEY)||'{}');
  const hist  = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
  if(Array.isArray(saved.cart)) state.cart=saved.cart;
  if(typeof saved.discountPct==='number') state.discountPct=saved.discountPct;
  if(saved.fulfillment) state.fulfillment=saved.fulfillment;
  if(saved.deliveryZone) state.deliveryZone=saved.deliveryZone;
  if(Array.isArray(hist)) state.history=hist;
}catch{}
const persist=()=>localStorage.setItem(STATE_KEY,JSON.stringify(state));
const persistHistory=()=>localStorage.setItem(HIST_KEY,JSON.stringify(state.history));

/* =========================
   RENDER: CARDS
========================= */
function cardHTML(item){
  const needsWizard = (item.ediblesIncluded||0)>0 || item.components || item.dynamic; // bundles
  const needsFlavor = item.needsFlavor===true;            // flavored vapes/refills
  const needsStrain = item.pickStrain===true;             // flower entry points
  const actionAttr  = needsWizard ? `data-wizard="${item.id}"` :
                      needsFlavor ? `data-flavor="${item.id}"` :
                      needsStrain ? `data-strain="${item.id}"` :
                                    `data-add="${item.id}"`;
  const cta         = needsWizard ? 'Choose &amp; Add' :
                      needsFlavor ? 'Pick Flavor &amp; Add' :
                      needsStrain ? 'Pick Strain &amp; Add' :
                                    'Add';
  const priceHtml   = (item.price!=null)
      ? `<span class="price">${currency(item.price)}</span>`
      : `<span class="price">custom</span>`;

  return `
  <article class="card">
    <h3 style="margin:0">${item.name}</h3>
    <div class="toolrow" style="justify-content:space-between">
      ${priceHtml}
      <div class="qty">
        <button aria-label="dec">−</button>
        <output>1</output>
        <button aria-label="inc">+</button>
      </div>
    </div>
    <button class="btn" ${actionAttr}>${cta}</button>
    ${item.description?`<div class="muted">${item.description}</div>`:''}
  </article>`;  
}

function renderCards(){
  const $ = sel => document.querySelector(sel);
  $('#vapes').innerHTML   = MENU.vapes.map(cardHTML).join('');
  $('#refills').innerHTML = MENU.refills.map(cardHTML).join('');
  $('#edibles').innerHTML = MENU.edibles.map(cardHTML).join('');
  $('#bundles').innerHTML = MENU.bundles.map(cardHTML).join('');
  $('#extras').innerHTML  = MENU.extras.map(cardHTML).join('');

  // Flower rows
  document.getElementById('flower-basic').innerHTML   = MENU.flowerEntry.filter(f=>f.tier==='Basic').map(cardHTML).join('');
  document.getElementById('flower-premium').innerHTML = MENU.flowerEntry.filter(f=>f.tier==='Premium').map(cardHTML).join('');
  document.getElementById('flower-exotic').innerHTML  = MENU.flowerEntry.filter(f=>f.tier==='Exotic').map(cardHTML).join('');

  const all = [...MENU.vapes, ...MENU.refills, ...MENU.edibles, ...MENU.bundles, ...MENU.extras, ...MENU.flowerEntry];

  document.querySelectorAll('.cards .card, .cards-2 .card').forEach(card=>{
    let count=1; const out=card.querySelector('output');
    card.querySelector('button[aria-label="dec"]')?.addEventListener('click',()=>{ count=Math.max(1,count-1); out.value=count; });
    card.querySelector('button[aria-label="inc"]')?.addEventListener('click',()=>{ count++; out.value=count; });

    const wizId    = card.querySelector('[data-wizard]')?.getAttribute('data-wizard');
    const flavorId = card.querySelector('[data-flavor]')?.getAttribute('data-flavor');
    const strainId = card.querySelector('[data-strain]')?.getAttribute('data-strain');
    const addId    = card.querySelector('[data-add]')?.getAttribute('data-add');

    if(wizId){
      const item = all.find(i=>i.id===wizId);
      card.querySelector('[data-wizard]').addEventListener('click',()=>openBundleWizard(item,count));
      return;
    }
    if(flavorId){
      const item = all.find(i=>i.id===flavorId);
      card.querySelector('[data-flavor]')?.addEventListener('click',()=>openFlavorPicker(item,count));
      return;
    }
    if(strainId){
      const item = all.find(i=>i.id===strainId);
      card.querySelector('[data-strain]')?.addEventListener('click',()=>openStrainPickerForTier(item,count));
      return;
    }
    if(addId){
      const item = all.find(i=>i.id===addId);
      card.querySelector('[data-add]')?.addEventListener('click',()=>{
        addToCart({ id:item.id, name:item.name, unitPrice:item.price, qty:count, type:item.type });
      });
    }
  });
}

/* =========================
   CART & TOTALS
========================= */
function addToCart(line){
  const key = `${line.id}|${line.unitPrice}|${line.type}|${line.meta||''}`;
  const match = state.cart.find(l =>
    `${l.id}|${l.unitPrice}|${l.type}|${l.meta||''}`===key &&
    JSON.stringify(l.pick||{})===JSON.stringify(line.pick||{}));
  if(match) match.qty += line.qty; else state.cart.push(line);
  persist(); renderCart(); renderTotals(); renderIngredients();
}

function renderCart(){
  const cart=document.getElementById('cart');
  if(!state.cart.length){ cart.innerHTML='<div class="cart-item muted">Your order is empty. Add an item to get started.</div>'; return; }
  cart.innerHTML = state.cart.map((l,i)=>`
    <div class="cart-item">
      <div>
        <div><strong>${l.name}</strong></div>
        <div class="muted">${currency(l.unitPrice)} each${l.meta?` • ${l.meta}`:''}</div>
      </div>
      <div class="qty">
        <button data-dec="${i}">−</button>
        <output>${l.qty}</output>
        <button data-inc="${i}">+</button>
      </div>
      <div><strong>${currency(l.unitPrice*l.qty)}</strong></div>
    </div>`).join('');

  cart.querySelectorAll('[data-inc]').forEach(b=>b.addEventListener('click',()=>{
    const i=+b.getAttribute('data-inc'); state.cart[i].qty++; persist(); renderCart(); renderTotals(); renderIngredients();
  }));
  cart.querySelectorAll('[data-dec]').forEach(b=>b.addEventListener('click',()=>{
    const i=+b.getAttribute('data-dec'); state.cart[i].qty--; if(state.cart[i].qty<=0) state.cart.splice(i,1);
    persist(); renderCart(); renderTotals(); renderIngredients();
  }));
}

const ZONE_FEES={city:50,sandy:100,paleto:150};
function renderFulfillment(){
  document.querySelectorAll('input[name="fulfill"]').forEach(r=> r.checked=(r.value===state.fulfillment));
  const zone=document.getElementById('zoneSelect'); zone.value=state.deliveryZone; zone.disabled = state.fulfillment!=='delivery';
}
document.querySelectorAll('input[name="fulfill"]').forEach(r=>r.addEventListener('change',e=>{
  state.fulfillment=e.target.value; persist(); renderFulfillment(); renderTotals();
}));
document.getElementById('zoneSelect').addEventListener('change',e=>{
  state.deliveryZone=e.target.value; persist(); renderTotals();
});

function computePromotions(){ return { discount:0, notes:[] }; }

function renderTotals(){
  const subtotal = state.cart.reduce((s,l)=>s + l.unitPrice*l.qty, 0);
  const manual = +(subtotal*(state.discountPct/100)).toFixed(2);
  const promo = computePromotions();
  const fee = state.fulfillment==='delivery' ? (ZONE_FEES[state.deliveryZone]||0) : 0;
  const total = subtotal + fee - manual - promo.discount;
  document.getElementById('subtotal').textContent=currency(subtotal);
  document.getElementById('discount').textContent='-'+currency(manual);
  document.getElementById('promotions').textContent='-'+currency(promo.discount);
  document.getElementById('total').textContent=currency(total);
  document.getElementById('promoNotes').textContent = promo.notes.join(' • ');
  const row=document.getElementById('deliveryRow');
  if(fee>0){ row.style.display='flex'; document.getElementById('deliveryFee').textContent=currency(fee); }
  else { row.style.display='none'; document.getElementById('deliveryFee').textContent=currency(0); }
}

const range=document.getElementById('discountRange'), label=document.getElementById('discountLabel');
function renderDiscount(){ range.value=state.discountPct; label.textContent = `${state.discountPct}%`; }
range.addEventListener('input',()=>{ state.discountPct=+range.value; persist(); renderTotals(); renderDiscount(); });

/* =========================
   HISTORY
========================= */
function renderHistory(){
  const list=document.getElementById('historyList');
  if(!state.history.length){ list.innerHTML='<div class="muted">No past orders yet.</div>'; return; }
  list.innerHTML = state.history.map(h=>`
    <article class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div><strong>${new Date(h.id).toLocaleString()}</strong><div class="muted">${h.items.length} items • ${h.discountPct}% off</div></div>
        <div><strong>${currency(h.total)}</strong></div>
      </div>
      <details class="muted" style="margin-top:6px">
        <summary>Items</summary>
        <ul style="margin:6px 0 0 16px">
          ${h.items.map(i=>`<li>${i.qty}× ${i.name}${i.meta?` <span class="muted">(${i.meta})</span>`:''} — ${currency(i.lineTotal)}</li>`).join('')}
        </ul>
      </details>
      <div class="toolrow" style="justify-content:flex-end">
        <button class="btn" data-reorder="${h.id}">Reorder</button>
        <button class="btn ghost" data-delete="${h.id}">Delete</button>
      </div>
    </article>`).join('');

  list.querySelectorAll('[data-reorder]').forEach(b=>b.addEventListener('click',()=>{
    const id=+b.getAttribute('data-reorder');
    const h=state.history.find(x=>x.id===id); if(!h) return;
    h.items.forEach(it=>addToCart({ id:it.id,name:it.name,unitPrice:it.unit,qty:it.qty,meta:it.meta||null,pick:it.pick||null,type:it.type||'extra' }));
  }));
  list.querySelectorAll('[data-delete]').forEach(b=>b.addEventListener('click',()=>{
    const id=+b.getAttribute('data-delete');
    state.history = state.history.filter(x=>x.id!==id); persistHistory(); renderHistory();
  }));
}
document.getElementById('clearHistoryBtn').addEventListener('click',()=>{ if(confirm('Clear order history?')){ state.history=[]; persistHistory(); renderHistory(); }});

/* =========================
   WIZARDS (bundles, flavors, strains)
========================= */
const comboModal=document.getElementById('comboModal');
const comboTitle=document.getElementById('comboTitle');
const comboSteps=document.getElementById('comboSteps');
const comboContent=document.getElementById('comboContent');
const comboPrev=document.getElementById('comboPrev');
const comboNext=document.getElementById('comboNext');
document.getElementById('closeCombo').addEventListener('click',()=>comboModal.close());

/* Edible bundle (existing) */
function openBundleWizard(item, qty){
  // Branch by bundle kind
  if(item.ediblesIncluded){ return openEdibleDuoWizard(item, qty); }
  if(item.components){ return openFixedComponentsBundle(item, qty); }
  if(item.dynamic){ return openDynamicBundleWizard(item, qty); }
}

/* ---- Edible Duo ---- */
function openEdibleDuoWizard(item, qty){
  const usedTotal = obj => Object.values(obj).reduce((a,b)=>a+b,0);
  const counts = {};
  let confirmMode=false;

  const pool = MENU.edibles;
  const needed = item.ediblesIncluded||0;
  const label = 'Edibles';

  function renderGrid(){
    const used=usedTotal(counts), remaining=needed-used;
    comboTitle.textContent = `${label}: pick ${needed} (remaining ${Math.max(0,remaining)})`;
    comboSteps.innerHTML = confirmMode ? `1. ${label} · <strong>2. Snack/Confirm</strong>` : `<strong>1. ${label}</strong> · 2. Snack/Confirm`;
    comboContent.innerHTML = `
      <div class="selector-grid">
        ${pool.map(p=>`
          <div class="select-card">
            <div class="select-title">${p.name}</div>
            <div class="select-qty">
              <button data-minus="${p.id}">−</button>
              <output data-out="${p.id}">${counts[p.id]||0}</output>
              <button data-plus="${p.id}">+</button>
            </div>
          </div>`).join('')}
      </div>`;

    comboContent.querySelectorAll('[data-plus]').forEach(b=>b.addEventListener('click',()=>{
      const id=b.getAttribute('data-plus'); if(usedTotal(counts)<needed){ counts[id]=(counts[id]||0)+1; renderGrid(); }
    }));
    comboContent.querySelectorAll('[data-minus]').forEach(b=>b.addEventListener('click',()=>{
      const id=b.getAttribute('data-minus'); counts[id]=Math.max(0,(counts[id]||0)-1); renderGrid();
    }));

    comboPrev.style.display='none';
    comboNext.textContent = confirmMode ? 'Add to Cart' : 'Next';
    comboNext.disabled = remaining>0;
  }

  let snackChoice=null;
  function renderConfirm(){
    comboTitle.textContent=item.name;
    const fmt = id => (MENU.edibles.find(x=>x.id===id)||{}).name || id;
    const parts = Object.entries(counts).filter(([,c])=>c>0).map(([id,c])=>`${fmt(id)} x${c}`);

    // Snack choice optional for future edible bundles; not included here by default
    comboSteps.innerHTML = `1. ${label} · <strong>2. Confirm</strong>`;
    comboContent.innerHTML = `<div class="summary" style="gap:10px;">
      ${parts.length?`<div><strong>${label}:</strong> ${parts.join(', ')}</div>`:''}
      ${item.description?`<div class="muted">${item.description}</div>`:''}
    </div>`;
    comboPrev.style.display='none';
    comboNext.textContent='Add to Cart';
    comboNext.disabled=false;
  }

  comboPrev.onclick = ()=>{};
  comboNext.onclick = ()=>{
    if(!confirmMode){ confirmMode=true; renderConfirm(); return; }
    addToCart({
      id:item.id, name:item.name, unitPrice:item.price, qty:qty||1, type:item.type,
      pick:counts, meta: `Edibles: ${Object.entries(counts).filter(([,c])=>c>0).map(([id,c])=>`${(MENU.edibles.find(x=>x.id===id)||{}).name||id} x${c}`).join(', ')}`
    });
    comboModal.close();
  };

  renderGrid();
  comboModal.showModal();
}

/* ---- Fixed components bundle (Starter / Flavor Fan / THC Chill) ---- */
function openFixedComponentsBundle(item, qty){
  let step = 1;
  const picks = { flavors:{} , snack:null };

  comboTitle.textContent = item.name;

  function findById(id){
    return [...MENU.vapes, ...MENU.refills, ...MENU.extras, ...MENU.edibles].find(x=>x.id===id);
  }

  function renderFlavorStepIfNeeded(){
    const flavored = (item.components||[]).filter(c=>c.id==='geek-flavor' || c.id==='refill-flavor' || c.needsFlavor);
    if(!flavored.length){ return false; }
    comboSteps.innerHTML = `<strong>1. Flavor</strong> · 2. Snack · 3. Confirm`;
    comboContent.innerHTML = flavored.map(f=>{
      const it=findById(f.id);
      const labelTxt = it ? `Flavor for ${it.name}` : 'Flavor';
      return `
      <div class="option-row">
        <label><strong>${labelTxt}</strong></label>
        <select data-flavor-for="${f.id}">
          ${VAPE_FLAVORS.map(fl=>`<option value="${fl}">${fl}</option>`).join('')}
        </select>
      </div>`;
    }).join('');
    comboPrev.style.display='none';
    comboNext.textContent='Next';
    comboNext.disabled=false;

    comboContent.querySelectorAll('[data-flavor-for]').forEach(sel=>{
      sel.addEventListener('change',()=>{ picks.flavors[sel.getAttribute('data-flavor-for')] = sel.value; });
      // init default
      picks.flavors[sel.getAttribute('data-flavor-for')] = sel.value;
    });
    return true;
  }

  function renderSnackStep(){
    comboSteps.innerHTML = item.components.some(c=>c.id) ? `1. Flavor · <strong>2. Snack</strong> · 3. Confirm` : `<strong>1. Snack</strong> · 2. Confirm`;
    const snackCards = SNACK_IDS.map(id=>{
      const s = MENU.extras.find(x=>x.id===id);
      return `<label class="option-row"><span>${s.name}</span><input type="radio" name="snack" value="${id}"></label>`;
    }).join('');
    comboContent.innerHTML = `<div class="option-list">${snackCards}</div>`;
    comboPrev.style.display='inline-flex';
    comboNext.textContent='Next';
    comboNext.disabled=true;

    comboContent.querySelectorAll('input[name="snack"]').forEach(r=>{
      r.addEventListener('change',()=>{ picks.snack=r.value; comboNext.disabled=false; });
    });
  }

  function renderConfirm(){
    comboSteps.innerHTML = item.components.some(c=>c.id) ? `1. Flavor · 2. Snack · <strong>3. Confirm</strong>` : `1. Snack · <strong>2. Confirm</strong>`;
    const parts = [];
    item.components.forEach(c=>{
      const it = [...MENU.vapes, ...MENU.refills].find(x=>x.id===c.id);
      if(!it) return;
      let note = '';
      if((it.id==='geek-flavor' || it.id==='refill-flavor')){
        const fl = picks.flavors[it.id] || VAPE_FLAVORS[0];
        note = ` (Flavor: ${fl})`;
      }
      parts.push(`${c.qty}× ${it.name}${note}`);
    });
    const snackName = (MENU.extras.find(x=>x.id===picks.snack)||{}).name || '';
    comboContent.innerHTML = `<div class="summary" style="gap:10px;">
      <div><strong>Included:</strong> ${parts.join(', ')}</div>
      <div><strong>Snack:</strong> ${snackName}</div>
      <div class="muted">${currency(item.price)} bundle</div>
    </div>`;
    comboPrev.style.display='inline-flex';
    comboNext.textContent='Add to Cart';
    comboNext.disabled=false;
  }

  comboPrev.onclick = ()=>{
    if(step===2){ // from Snack back to Flavor or close
      const hadFlavor = (item.components||[]).some(c=>c.id==='geek-flavor' || c.id==='refill-flavor' || c.needsFlavor);
      if(hadFlavor){ step=1; renderFlavorStepIfNeeded(); }
      else { comboModal.close(); }
    } else if(step===3){
      step=2; renderSnackStep();
    }
  };

  comboNext.onclick = ()=>{
    const hadFlavor = renderFlavorStepIfNeeded();
    if(step===1){
      if(hadFlavor){ step=2; renderSnackStep(); }
      else { step=2; renderSnackStep(); }
      return;
    }
    if(step===2){ step=3; renderConfirm(); return; }

    // Add to cart
    const metaBits=[];
    if(picks.flavors['geek-flavor'])   metaBits.push(`Geek Flavor: ${picks.flavors['geek-flavor']}`);
    if(picks.flavors['refill-flavor']) metaBits.push(`Refill Flavor: ${picks.flavors['refill-flavor']}`);
    const snackMeta  = (MENU.extras.find(x=>x.id===picks.snack)||{}).name;
    if(snackMeta) metaBits.push(`Snack: ${snackMeta}`);
    addToCart({
      id:item.id, name:item.name, unitPrice:item.price, qty:qty||1, type:item.type,
      meta: metaBits.join(' • ') || null
    });
    comboModal.close();
  };

  // Kickoff
  if(!renderFlavorStepIfNeeded()){ step=2; renderSnackStep(); } else { step=1; }
  comboModal.showModal();
}

/* ---- Dynamic bundles (Vape Duo/Trio, Refill 2/3) ---- */
function openDynamicBundleWizard(item, qty){
  const dyn = item.dynamic;
  const pool = (dyn.from==='vapes') ? MENU.vapes.filter(v=>v.type==='vape') :
               (dyn.from==='refills') ? MENU.refills :
               [];
  const counts = {};
  let step=1;
  let selectedSnack=null;
  let vapeFlavor=null;
  let refillFlavor=null;

  function totalSelected(){ return Object.values(counts).reduce((a,b)=>a+b,0); }

  function renderPick(){
    comboTitle.textContent = item.name;
    comboSteps.innerHTML = `<strong>1. Pick Items</strong> · 2. Options · 3. Confirm`;
    comboContent.innerHTML = `
      <div class="selector-grid">
        ${pool.map(p=>`
          <div class="select-card">
            <div class="select-title">${p.name}</div>
            <div class="muted">${currency(p.price)}</div>
            <div class="select-qty">
              <button data-minus="${p.id}">−</button>
              <output data-out="${p.id}">${counts[p.id]||0}</output>
              <button data-plus="${p.id}">+</button>
            </div>
          </div>`).join('')}
      </div>
      <div class="muted">Pick exactly ${dyn.count} item(s).</div>
    `;
    comboPrev.style.display='none';
    comboNext.textContent='Next';
    comboNext.disabled = totalSelected()!==dyn.count;

    comboContent.querySelectorAll('[data-plus]').forEach(b=>b.addEventListener('click',()=>{
      const id=b.getAttribute('data-plus');
      if(totalSelected()<dyn.count){ counts[id]=(counts[id]||0)+1; renderPick(); }
    }));
    comboContent.querySelectorAll('[data-minus]').forEach(b=>b.addEventListener('click',()=>{
      const id=b.getAttribute('data-minus');
      counts[id]=Math.max(0,(counts[id]||0)-1); renderPick();
    }));
  }

  const needsFlavorStep = () => 
    (dyn.from==='vapes'   && counts['geek-flavor']   > 0) ||
    (dyn.from==='refills' && counts['refill-flavor'] > 0);

  const needsSnackStep  = !!item.snackChoice || !!dyn.snackFree;

  function renderOptions(){
    step=2;
    const pieces=[];
    if(dyn.from==='vapes' && counts['geek-flavor']>0){
      pieces.push(`
        <div class="option-row">
          <label><strong>Flavor for Flavored Geek</strong></label>
          <select id="bundleFlavorSelVape">
            ${VAPE_FLAVORS.map(f=>`<option value="${f}">${f}</option>`).join('')}
          </select>
        </div>
      `);
    }
    if(dyn.from==='refills' && counts['refill-flavor']>0){
      pieces.push(`
        <div class="option-row">
          <label><strong>Flavor for Flavored Refill</strong></label>
          <select id="bundleFlavorSelRefill">
            ${VAPE_FLAVORS.map(f=>`<option value="${f}">${f}</option>`).join('')}
          </select>
        </div>
      `);
    }
    if(needsSnackStep()){
      const snackRows = SNACK_IDS.map(id=>{
        const s = MENU.extras.find(x=>x.id===id);
        return `<label class="option-row"><span>${s.name}</span><input type="radio" name="snack" value="${id}"></label>`;
      }).join('');
      pieces.push(`<div class="option-list">${snackRows}</div>`);
    }

    comboSteps.innerHTML = `1. Pick Items · <strong>2. Options</strong> · 3. Confirm`;
    comboContent.innerHTML = pieces.join('') || `<div class="muted">No extra options for this bundle.</div>`;
    comboPrev.style.display='inline-flex';
    comboNext.textContent='Next';

    const updateDisabled = ()=>{
      const needV = (dyn.from==='vapes'   && counts['geek-flavor']>0) && !vapeFlavor;
      const needR = (dyn.from==='refills' && counts['refill-flavor']>0) && !refillFlavor;
      const needS = needsSnackStep() && !selectedSnack;
      comboNext.disabled = needV || needR || needS;
    };

    const selV = document.getElementById('bundleFlavorSelVape');
    if(selV){ vapeFlavor = selV.value; selV.addEventListener('change',()=>{ vapeFlavor = selV.value; updateDisabled(); }); }
    const selR = document.getElementById('bundleFlavorSelRefill');
    if(selR){ refillFlavor = selR.value; selR.addEventListener('change',()=>{ refillFlavor = selR.value; updateDisabled(); }); }

    comboContent.querySelectorAll('input[name="snack"]').forEach(r=>{
      r.addEventListener('change',()=>{ selectedSnack=r.value; updateDisabled(); });
    });
    updateDisabled();
  }

  function renderConfirm(){
    step=3;
    // compute price
    const sum = Object.entries(counts).reduce((acc,[id,c])=>{
      const it = pool.find(x=>x.id===id); return acc + (it?it.price*c:0);
    },0);
    const discounted = +(sum * (1 - (dyn.discountPct||0)/100)).toFixed(2);
    const finalPrice = discounted; // snack is free if snackFree; already excluded
    const descParts=[];
    Object.entries(counts).forEach(([id,c])=>{
      const it=pool.find(x=>x.id===id);
      if(!it) return;
      let note='';
      if(it.id==='geek-flavor'   && vapeFlavor)   note=` (Flavor: ${vapeFlavor})`;
      if(it.id==='refill-flavor' && refillFlavor) note=` (Flavor: ${refillFlavor})`;
      descParts.push(`${c}× ${it.name}${note}`);
    });
    const snackName = selectedSnack ? (MENU.extras.find(x=>x.id===selectedSnack)||{}).name : null;

    comboSteps.innerHTML = `1. Pick Items · 2. Options · <strong>3. Confirm</strong>`;
    comboContent.innerHTML = `<div class="summary" style="gap:10px;">
      <div><strong>Selection:</strong> ${descParts.join(', ')}</div>
      ${snackName?`<div><strong>Snack:</strong> ${snackName} (free)</div>`:''}
      <div><strong>Bundle Price:</strong> ${currency(finalPrice)}</div>
      <div class="muted">Discount applied: ${dyn.discountPct||0}%</div>
    </div>`;
    comboPrev.style.display='inline-flex';
    comboNext.textContent='Add to Cart';
    comboNext.disabled=false;

    comboNext.onclick = ()=>{
      const metaBits=[];
      if(vapeFlavor)   metaBits.push(`Geek Flavor: ${vapeFlavor}`);
      if(refillFlavor) metaBits.push(`Refill Flavor: ${refillFlavor}`);
      if(snackName)    metaBits.push(`Snack: ${snackName}`);
      addToCart({
        id:item.id,
        name:item.name,
        unitPrice:finalPrice,
        qty:qty||1,
        type:item.type,
        meta: metaBits.join(' • ') || null,
        pick: counts
      });
      comboModal.close();
    };
  }

  comboPrev.onclick = ()=>{
    if(step===2){ renderPick(); step=1; }
    else if(step===3){ renderOptions(); step=2; }
  };
  comboNext.onclick = ()=>{
    if(step===1){ renderOptions(); }
    else if(step===2){ renderConfirm(); }
  };

  renderPick();
  comboModal.showModal();
}

/* ---- Flavor picker for single items (vape + refill flavored) ---- */
function openFlavorPicker(item, qty){
  comboTitle.textContent = `Choose Flavor — ${item.name}`;
  comboSteps.innerHTML = `<strong>1. Flavor</strong> · 2. Confirm`;
  let selected = VAPE_FLAVORS[0] || 'Strawberry';
  let confirmMode=false;

  function renderChoices(){
    comboContent.innerHTML = `
      <div class="option-list">
        ${VAPE_FLAVORS.map(f=>`
          <div class="option-row">
            <label><input type="radio" name="vflavor" value="${f}" ${f===selected?'checked':''}/> ${f}</label>
          </div>`).join('')}
      </div>`;
    comboPrev.style.display='none';
    comboNext.textContent='Next';
    comboNext.disabled=false;
    comboContent.querySelectorAll('input[name="vflavor"]').forEach(r=>{
      r.addEventListener('change',()=>{ selected=r.value; });
    });
  }

  function renderConfirm(){
    comboTitle.textContent = `${item.name}`;
    comboSteps.innerHTML = `1. Flavor · <strong>2. Confirm</strong>`;
    comboContent.innerHTML = `<div class="summary" style="gap:10px;">
      <div><strong>Flavor:</strong> ${selected}</div>
      <div class="muted">${currency(item.price)} each</div>
    </div>`;
    comboPrev.style.display='none';
    comboNext.textContent='Add to Cart';
    comboNext.disabled=false;
  }

  comboPrev.onclick = ()=>{};
  comboNext.onclick = ()=>{
    if(!confirmMode){ confirmMode=true; renderConfirm(); return; }
    addToCart({
      id:item.id, name:item.name, unitPrice:item.price, qty:qty||1, type:item.type,
      meta:`Flavor: ${selected}`
    });
    comboModal.close();
  };

  renderChoices();
  comboModal.showModal();
}

/* ---- Strain picker for a fixed tier (Basic/Premium/Exotic) ---- */
function openStrainPickerForTier(item, qty){
  const tier = item.tier;
  const group = STRAIN_GROUPS.find(g=>g.tier===tier);
  const price = item.price;
  let selected = group.items[0];

  comboTitle.textContent = `Choose Strain — ${item.name}`;
  comboSteps.innerHTML = `<strong>1. Strain</strong> · 2. Confirm`;

  let confirmMode=false;

  function renderStrains(){
    comboContent.innerHTML = `
      <div class="option-list">
        ${group.items.map(s=>`
          <div class="option-row">
            <label><input type="radio" name="strain" value="${s}" ${s===selected?'checked':''}/> ${s}</label>
          </div>`).join('')}
      </div>`;
    comboPrev.style.display='none';
    comboNext.textContent='Next';
    comboNext.disabled=false;

    comboContent.querySelectorAll('input[name="strain"]').forEach(r=>{
      r.addEventListener('change',()=>{ selected=r.value; });
    });
  }

  function renderConfirm(){
    comboSteps.innerHTML = `1. Strain · <strong>2. Confirm</strong>`;
    comboContent.innerHTML = `<div class="summary" style="gap:10px;">
      <div><strong>Strain:</strong> ${selected} (${tier})</div>
      <div class="muted">${currency(price)} each</div>
    </div>`;
    comboPrev.style.display='none';
    comboNext.textContent='Add to Cart';
    comboNext.disabled=false;
  }

  comboPrev.onclick = ()=>{};
  comboNext.onclick = ()=>{
    if(!confirmMode){ confirmMode=true; renderConfirm(); return; }
    addToCart({
      id:item.id,
      name:item.name,
      unitPrice:price,
      qty:qty||1,
      type:item.type,
      meta:`Strain: ${selected} (${tier})`
    });
    comboModal.close();
  };

  renderStrains();
  comboModal.showModal();
}

/* =========================
   INGREDIENTS
========================= */
function aggregateIngredients(){
  const add=(m,o)=>{ o[m]=(o[m]||0)+1; };
  const tally={};
  state.cart.forEach(line=>{
    if(RECIPE_MAP[line.id]){
      for(const [ing,count] of Object.entries(RECIPE_MAP[line.id])){
        for(let i=0;i<count*line.qty;i++) add(ing,tally);
      }
    }
    if(line.pick){
      for(const [id,c] of Object.entries(line.pick)){
        if(RECIPE_MAP[id]){
          for(const [ing,n] of Object.entries(RECIPE_MAP[id])){
            const total = n * c * (line.qty||1);
            tally[ing]=(tally[ing]||0)+total;
          }
        }
      }
    }
  });
  return tally;
}
function renderIngredients(){
  const wrap=document.getElementById('ingredientList');
  const entries=Object.entries(aggregateIngredients()).sort((a,b)=>a[0].localeCompare(b[0]));
  if(!entries.length){ wrap.innerHTML='<div class="muted">No ingredients yet. Add items to the cart.</div>'; return; }
  wrap.innerHTML = entries.map(([n,c])=>`<div style="display:grid;grid-template-columns:1fr auto;gap:8px"><div>${n}</div><div><strong>x${c}</strong></div></div>`).join('');
}

document.getElementById('copyIngBtn').addEventListener('click',()=>{
  const txt=Object.entries(aggregateIngredients()).sort((a,b)=>a[0].localeCompare(b[0])).map(([n,c])=>`- ${n} x${c}`).join('\n');
  navigator.clipboard.writeText(txt).then(()=>alert('Ingredients copied!'));
});
document.getElementById('exportIngBtn').addEventListener('click',()=>{
  const rows=[['Ingredient','Count'],...Object.entries(aggregateIngredients()).sort((a,b)=>a[0].localeCompare(b[0]))];
  const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='green_wonderland_ingredients.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* =========================
   INIT / THEME / CHECKOUT
========================= */
function renderAll(){ renderCards(); renderCart(); renderFulfillment(); renderTotals(); renderDiscount(); renderIngredients(); renderHistory(); }
function checkout(){
  if(!state.cart.length){ alert('Your order is empty.'); return; }
  const subtotal=state.cart.reduce((s,l)=>s+l.unitPrice*l.qty,0);
  const manual=+(subtotal*(state.discountPct/100)).toFixed(2);
  const promo=computePromotions();
  const fee=state.fulfillment==='delivery'?(ZONE_FEES[state.deliveryZone]||0):0;
  const total=+(subtotal+fee-manual-promo.discount).toFixed(2);
  const entry={ id:Date.now(),
    items:state.cart.map(l=>({id:l.id,name:l.name,qty:l.qty,unit:l.unitPrice,meta:l.meta||null,pick:l.pick||null,type:l.type||'extra',lineTotal:+(l.unitPrice*l.qty).toFixed(2)})),
    discountPct:state.discountPct, subtotal:+subtotal.toFixed(2), deliveryFee:fee, promoDiscount:promo.discount, manualDiscount:manual, total };
  state.history.unshift(entry); persistHistory();
  state.cart=[]; state.discountPct=0; persist(); renderAll(); selectTab('summary');
}
function resetAll(){ state.cart=[]; state.discountPct=0; persist(); renderAll(); }

document.getElementById('checkoutBtn').addEventListener('click',checkout);
document.getElementById('checkoutBtn2').addEventListener('click',checkout);
document.getElementById('resetBtn').addEventListener('click',resetAll);
document.getElementById('resetBtn2').addEventListener('click',resetAll);

const themeBtn=document.getElementById('themeBtn');
function applyTheme(t){ document.documentElement.setAttribute('data-theme',t); localStorage.setItem('gw_theme',t); themeBtn.textContent = t==='dark' ? '☀️ Light' : '🌙 Dark'; themeBtn.setAttribute('aria-pressed',t==='dark'); }
applyTheme(localStorage.getItem('gw_theme')||'light');
themeBtn.addEventListener('click',()=>applyTheme((localStorage.getItem('gw_theme')||'light')==='light'?'dark':'light'));

const tabButtons=document.querySelectorAll('[data-tab]');
function selectTab(which){
  document.getElementById('tab-summary').hidden = which!=='summary';
  document.getElementById('tab-ingredients').hidden = which!=='ingredients';
  document.getElementById('tab-history').hidden = which!=='history';
  tabButtons.forEach(b=>b.setAttribute('aria-selected', String(b.getAttribute('data-tab')===which)));
}
tabButtons.forEach(b=>b.addEventListener('click',()=>selectTab(b.getAttribute('data-tab'))));

renderAll();
</script>
</body>
</html>
